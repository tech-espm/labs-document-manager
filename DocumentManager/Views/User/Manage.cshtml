@model List<User>
@{
	ViewBag.Title = "Gerenciar Usuários";
}

<div class="modal fade" tabindex="-1" role="dialog" id="modalProfileId">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Fechar"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title">Alterar Perfil</h4>
			</div>
			<div class="modal-body">
				<div class="form-group">
					<label for="profileId">Perfil</label>
					<select id="profileId" name="profileId" size="1" class="form-control">
						<option value="" selected="selected">SELECIONE...</option>
						@foreach (Profile profile in Profile.GetAll()) {
							<option value="@profile.Id">@profile.Name</option>
						}
					</select>
					<script type="text/javascript">
						//<![CDATA[
						"use strict";
						prepareCbSearch(document.getElementById("profileId"));
						//]]>
					</script>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary" id="btnProfileId"><i class="fa fa-check"></i>Alterar Perfil</button>
				<button type="button" class="btn btn-outline btn-default" data-dismiss="modal"><i class="fa fa-times"></i>Cancelar</button>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" tabindex="-1" role="dialog" id="modalActivation">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Fechar"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title">Oops...</h4>
			</div>
			<div class="modal-body">
				<p class="no-margin-bottom" id="pActivation"></p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary" id="btnActivation"><i class="fa fa-check"></i>OK</button>
				<button type="button" class="btn btn-outline btn-default" data-dismiss="modal"><i class="fa fa-times"></i>Cancelar</button>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" tabindex="-1" role="dialog" id="modalResetPassword">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Fechar"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title">Oops...</h4>
			</div>
			<div class="modal-body">
				<p class="no-margin-bottom" id="pResetPassword"></p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary" id="btnResetPassword"><i class="fa fa-check"></i>OK</button>
				<button type="button" class="btn btn-outline btn-default" data-dismiss="modal"><i class="fa fa-times"></i>Cancelar</button>
			</div>
		</div>
	</div>
</div>

<div class="row">
	<div class="col-lg-12">
		<div class="panel panel-default">
			<div class="panel-body dataTable_wrapper">
				<table class="table table-striped table-hover" id="dataTableMain"></table>
			</div>
		</div>
	</div>
</div>

@section Scripts {
<script type="text/javascript">
		//<![CDATA[
		"use strict";

		window.dataTableMain = prepareDataTable("dataTableMain", {
			order: [[0, "asc"]],
			columns: [
				{ title: "Login", "class": "col-min" },
				{ title: "Nome", "class": "col-max", render: encode },
				{ title: "Perfil", "class": "col-min text-center" },
				{ title: " ", "class": "col-min", searchable: false, orderable: false }
			],
			data: [
				@foreach (User user in Model) {
					<text>
				[
					"<img class=\"profile-img\" alt=\"Perfil\" src=\"/images/user.png\" width=\"40\" height=\"40\" />" + encode("@user.UserName"),
					"@Html.Raw(System.Web.HttpUtility.JavaScriptStringEncode(user.FullName))",
					"<button id=\"btnProfile@(user.Id)\" type=\"button\" class=\"btn btn-outline btn-primary btn-block\" onclick=\"changeProfile(this, '@user.UserName', @user.Id)\">" + encode("@Html.Raw(System.Web.HttpUtility.JavaScriptStringEncode(user.ProfileName))") + "</button>",
					"@Html.Raw(user.Active ? "<button type=\\\"button\\\" class=\\\"btn btn-outline btn-danger\\\" onclick=\\\"activateUser(0, '" + user.UserName + "', " + user.Id + ");\\\"><i class=\\\"fa fa-times\\\"></i> Desativar</button>" : "<button type=\\\"button\\\" class=\\\"btn btn-outline btn-success\\\" onclick=\\\"activateUser(1, '" + user.UserName + "', " + user.Id + ");\\\"><i class=\\\"fa fa-check\\\"></i> Ativar</button>") <button type=\"button\" class=\"btn btn-outline btn-primary\" onclick=\"resetPassword('@user.UserName', @user.Id)\"><i class=\"fa fa-refresh\"></i>Redefinir senha</button>"
				],
					</text>
				}
			],
			deferRender: true,
			export: { title: "Usuários" }
		});

		function changeProfile(btn, userName, id) {
			if (JsonWebApi.active)
				return;

			setCbSearch(_("profileId"), "");

			_("btnProfileId").onclick = function () {
				var cbProfileId = _("profileId"), profileId = parseInt(cbProfileId.value), profileName;

				if (JsonWebApi.active)
					return;

				$("#modalProfileId").modal("hide");

				profileName = cbProfileId.options[cbProfileId.options.selectedIndex].textContent;

				Notification.wait();

				JsonWebApi.get("@Url.Action("SetProfile")", function (response) {
					if (response.success)
						location.reload(true);
					else
						Notification.error(response.value, true);
				}, "id", id, "profileId", profileId);
			};

			$("#modalProfileId").modal({
				backdrop: true,
				keyboard: true
			});
		}

		function activateUser(how, userName, id) {
			if (JsonWebApi.active)
				return;

			_("pActivation").textContent = (how ? "Deseja mesmo ativar o usuário \"" + userName + "\"?" : "Deseja mesmo desativar o usuário \"" + userName + "\"?");

			_("btnActivation").onclick = function () {
				if (JsonWebApi.active)
					return;

				$("#modalActivation").modal("hide");

				Notification.wait();

				JsonWebApi.get(how ? "@Url.Action("Activate")" : "@Url.Action("Deactivate")", function (response) {
					Notification.hide();

					if (response.success)
						location.reload(true);
					else
						Notification.error(response.value, true);
				}, "id", id);
			};

			$("#modalActivation").modal({
				backdrop: true,
				keyboard: true
			});
		}

		function resetPassword(userName, id) {
			if (JsonWebApi.active)
				return;

			_("pResetPassword").textContent = "Deseja mesmo redefinir a senha do usuário \"" + userName + "\" para \"1234\"?";

			_("btnResetPassword").onclick = function () {
				if (JsonWebApi.active)
					return;

				$("#modalResetPassword").modal("hide");

				Notification.wait();

				JsonWebApi.get("@Url.Action("ResetPassword")", function (response) {
					Notification.hide();

					if (response.success)
						Notification.success("Senha do usuário \"" + userName + "\" redefinida para \"1234\" com sucesso! \uD83D\uDE04");
					else
						Notification.error(response.value, true);
				}, "id", id);
			};

			$("#modalResetPassword").modal({
				backdrop: true,
				keyboard: true
			});
		}
		//]]>
</script>
}
